<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Interactive History Exam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .question-card { transition: all 0.3s ease; }
        .question-card:hover { transform: translateY(-2px); }
        .option-btn { transition: all 0.2s ease; }
        .option-btn:hover { background-color: #e5e7eb; }
        .correct { background-color: #10b981 !important; color: white; }
        .incorrect { background-color: #ef4444 !important; color: white; }
        .explanation { display: none; margin-top: 10px; padding: 10px; background-color: #f3f4f6; border-radius: 5px; }
        #progressBar { width: 0%; transition: width 0.3s ease; }
        #loading { display: block; }
        #examContent { display: none; }
    </style>
</head>
<body>
<div class="max-w-5xl mx-auto">
    <!-- Loading Screen -->
    <div id="loading" class="bg-white rounded-lg shadow-lg p-6 text-center">
        <h1 id="loadingTitle" class="text-3xl font-bold text-gray-800 mb-2">Loading Exam Questions...</h1>
        <p id="loadingDesc" class="text-gray-600">Please wait while we load your questions from the text file.</p>
    </div>

    <!-- Main Exam Content -->
    <div id="examContent">
        <!-- Tabs: Categories and Sets -->
        <div class="bg-white rounded-lg shadow-lg p-4 mb-6">
            <div class="mb-2">
                <h2 class="text-xl font-semibold text-gray-800">Select Exam Set</h2>
            </div>
            <!-- Category Tabs -->
            <div id="categoryTabs" class="flex flex-wrap gap-2 border-b pb-2"></div>
            <!-- Set Tabs (nested) -->
            <div id="setTabs" class="flex flex-wrap gap-2 mt-3"></div>
        </div>

        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-4">Interactive History Exam</h1>

            <!-- Progress Bar -->
            <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
                <div id="progressBar" class="bg-blue-600 h-2 rounded-full"></div>
            </div>

            <!-- Score Display -->
            <div class="text-center">
                <span id="scoreDisplay" class="text-lg font-semibold">Score: 0/0</span>
                <span id="questionCounter" class="text-gray-600 ml-4">Question: 0/0</span>
            </div>
            </div>

        <!-- Question Display Area -->
        <div id="questionContainer" class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="question-card">
                <h2 id="questionText" class="text-xl font-semibold mb-4"></h2>
                <div id="optionsContainer" class="space-y-3"></div>
                <div id="explanationContainer" class="explanation"></div>
                <div class="flex justify-between mt-6">
                    <button id="prevBtn" onclick="previousQuestion()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600" disabled>Previous</button>
                    <button id="nextBtn" onclick="nextQuestion()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700" disabled>Next</button>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsContainer" class="bg-white rounded-lg shadow-lg p-6" style="display: none;">
            <h2 class="text-2xl font-bold text-center mb-4">Exam Results</h2>
                <div id="finalScore" class="text-center text-3xl font-bold mb-4"></div>
                <div id="detailedResults" class="space-y-2"></div>
                <div class="text-center mt-6">
                    <button onclick="restartExam()" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">Restart Exam</button>
                </div>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mt-4" style="display: none;">
            <strong>Error:</strong> Could not load questions file. Make sure the file exists in the same folder.
        </div>
    </div>

    <script>
        // ==========================
        // Configuration: Nested Tabs
        // ==========================
        const EXAM_CONFIG = [
            {
                label: 'Ancient History',
                sets: [
                    { label: 'Set 1', file: 'questions.txt' }
                ]
            ];
    
        // ==========================
        // State
        // ==========================
        let questions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let userAnswers = [];
        let answered = false;
    
        let activeCategoryIndex = 0;
        let activeSetIndex = 0;
        
        // ==========================
        // UI Helpers
        // ==========================
        function showLoading(show, title = 'Loading Exam Questions...', desc = 'Please wait while we load your questions from the text file.') {
            document.getElementById('loadingTitle').textContent = title;
            document.getElementById('loadingDesc').textContent = desc;
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            if (show) {
                document.getElementById('errorMessage').style.display = 'none';
            }
        }
        
        function setError(msg) {
            const el = document.getElementById('errorMessage');
            el.innerHTML = '<strong>Error:</strong> ' + msg;
            el.style.display = 'block';
        }
        
        function computeScore() {
            if (!questions.length) return 0;
            return userAnswers.reduce((acc, ans, i) => acc + (ans === questions[i]?.correct ? 1 : 0), 0);
        }
        
        // ==========================
        // Tabs Rendering
        // ==========================
        function renderTabs() {
            const categoryTabs = document.getElementById('categoryTabs');
            const setTabs = document.getElementById('setTabs');
            
            // Render category tabs
            categoryTabs.innerHTML = '';
            EXAM_CONFIG.forEach((cat, idx) => {
                const btn = document.createElement('button');
                btn.className = 'px-3 py-2 rounded-t text-sm font-medium ' +
                            (idx === activeCategoryIndex ? 'tab-active' : '');
                btn.textContent = cat.label;
                btn.onclick = () => selectCategory(idx);
                categoryTabs.appendChild(btn);
            });
            
            // Render set tabs for active category
            setTabs.innerHTML = '';
            const activeCategory = EXAM_CONFIG[activeCategoryIndex];
            activeCategory.sets.forEach((set, idx) => {
                const btn = document.createElement('button');
                btn.className = 'px-3 py-1.5 rounded border text-sm font-medium ' +
                            (idx === activeSetIndex
                                ? 'bg-blue-600 text-white border-blue-600'
                                : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-100');
                btn.textContent = set.label;
                btn.onclick = () => selectSet(idx);
                setTabs.appendChild(btn);
            });
        });
            
        // Render set tabs for active category
        setTabs.innerHTML = '';
        const activeCategory = EXAM_CONFIG[activeCategoryIndex];
        activeCategory.sets.forEach((set, idx) => {
            const btn = document.createElement('button');
            btn.className = 'px-3 py-1.5 rounded border text-sm font-medium ' +
                            (idx === activeSetIndex
                                ? 'bg-blue-600 text-white border-blue-600'
                                : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-100');
            btn.textContent = set.label;
            btn.onclick = () => selectSet(idx);
            setTabs.appendChild(btn);
        });
        }
        
        // Select category
        function selectCategory(idx) {
            activeCategoryIndex = idx;
            activeSetIndex = 0; // reset to first set of the new category
            renderTabs();
            loadActiveSet();
        }
        
        function selectSet(idx) {
            activeSetIndex = idx;
            renderTabs();
            loadActiveSet();
        }
        
        function getActiveSetInfo() {
            const cat = EXAM_CONFIG[activeCategoryIndex];
            return { category: cat.label, ...cat.sets[activeSetIndex] }; // { category, label, file }
        }
        
        async function loadActiveSet() {
            const { category, label, file } = getActiveSetInfo();
            showLoading(true, `Loading: ${category} â€¢ ${label}`, `Fetching ${file} from the server...`);
            await loadQuestionsFromFile(file);
        }
        
        // Fixed parser for your specific format
        function parseQuestions(content) {
            // Normalize newlines and trim
            const text = content.replace(/^\uFEFF/, '').replace(/\r\n?/g, '\n').trim();
            
            // Split on numbered questions
            const blocks = text.split(/(?=^\d+\.\s)/m);
            questions = [];
            
            for (const rawBlock of blocks) {
                const lines = rawBlock.trim().split('\n').map(l => l.trim()).filter(Boolean);
                if (!lines.length) continue;
                
                // Extract question text (remove number prefix)
                const questionText = lines[0].replace(/^\d+\.\s*/, '').trim();
                
                // Extract exactly 4 options (supports a) b) c) d)
                const options = [];
                let i = 1;
                while (i < lines.length && options.length < 4) {
                    const line = lines[i];
                    // Match lines like "a) Option text", "A) Option text", "(A) Option text"
                    const match = line.match(/^\s*KATEX_INLINE_OPEN?([A-Da-d])[KATEX_INLINE_CLOSE\.\-:]?\s*(.+)$/);
                    if (match) options.push(match[1].trim());
                    i++;
                }
                
                // Find answer and explanation
                let correctLetter = null;
                let explanation = 'No explanation provided.';
                for (; i < lines.length; i++) {
                    const line = lines[i];
                    
                    // Look for "Answer:" followed by a letter
                    const ansMatch = line.match(/^(?:Answer|Ans):\s*([a-zA-Z])/i);
                    if (ansMatch && !correctLetter) {
                        correctLetter = ansMatch[1].toUpperCase();
                        continue;
                    }
                    
                    const expMatch = line.match(/^(?:Explanation|Explain):\s*(.*)/i);
                    if (expMatch) {
                        explanation = expMatch[1].trim();
                        const rest = lines.slice(i + 1).join(' ').trim();
                        if (rest) explanation += ' ' + rest;
                        break;
                    }
                }
                
                if (questionText && options.length === 4 && correctLetter) {
                    questions.push({
                        text: questionText,
                        options,
                        correct: correctLetter,
                        explanation
                    });
                }
            }
        }
        
        // Initialize exam
        function initializeExam() {
            currentQuestionIndex = 0;
            userAnswers = new Array(questions.length).fill(null);
            answered = false;
            
            document.getElementById('questionContainer').style.display = 'block';
            document.getElementById('resultsContainer').style.display = 'none';
            
            updateDisplay();
            displayQuestion();
        }
        
        // Display current question
        function displayQuestion() {
            const q = questions[currentQuestionIndex];
            if (!q) return;
            
            document.getElementById('questionText').textContent = `${currentQuestionIndex + 1}. ${q.text}`;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            q.options.forEach((opt, idx) => {
                const optionLetter = String.fromCharCode(65 + idx); // A, B, C, D
                const button = document.createElement('button');
                button.className = 'option-btn w-full text-left p-3 border rounded-lg hover:bg-gray-100';
                button.textContent = `${optionLetter}. ${opt}`;
                button.onclick = () => selectAnswer(optionLetter);
                optionsContainer.appendChild(button);
            });
            
            // If already answered, show states and explanation
            if (answered) {
                const buttons = document.querySelectorAll('.option-btn');
                buttons.forEach((btn, index) => {
                    const letter = String.fromCharCode(65 + index);
                    if (letter === q.correct) {
                        btn.classList.add('correct');
                    } else if (letter === savedAnswer && savedAnswer !== q.correct) {
                        btn.classList.add('incorrect');
                    }
                    btn.disabled = true;
                }
            });
            
            const explanationContainer = document.getElementById('explanationContainer');
            explanationContainer.innerHTML = `<strong>Explanation:</strong> ${q.explanation}`;
            explanationContainer.style.display = 'block';
            });
            
            updateDisplay();
            updateButtons();
        }
        
        // Navigation functions
        function nextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            } else if (answered) {
                showResults();
            }
        }
        
        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
            }
        }
        
        function updateDisplay() {
            const total = questions.length;
            const score = computeScore();
            
            document.getElementById('scoreDisplay').textContent = `Score: ${score}/${total}`;
            document.getElementById('questionCounter').textContent = `Question: ${total ? currentQuestionIndex + 1 : 0}/${total}`;
            
            const progress = total ? ((currentQuestionIndex + 1) / total) * 100 : 0;
            document.getElementById('progressBar').style.width = `${progress}%`;
        }
        
        function updateButtons() {
            const isFirst = currentQuestionIndex === 0;
            const isLast = currentQuestionIndex === questions.length - 1;
            
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            prevBtn.disabled = isFirst;
            nextBtn.textContent = isLast ? 'Show Results' : 'Next';
            nextBtn.disabled = !answered;
        }
    }
    
    function showResults() {
        document.getElementById('questionContainer').style.display = 'none';
        document.getElementById('resultsContainer').style.display = 'block';
        
        const percentage = total ? Math.round((score / total) * 100) : 0;
        document.getElementById('finalScore').textContent = `${score}/${total} (${percentage}%)`;
        
        const detailedResults = document.getElementById('detailedResults');
        detailedResults.innerHTML = '';
        
        questions.forEach((question, index) => {
            const userAnswer = userAnswers[index];
            const isCorrect = userAnswer === question.correct;
            
            const resultDiv = document.createElement('div');
            resultDiv.className = `p-3 rounded ${isCorrect ? 'bg-green-100' : 'bg-red-100'}`;
            resultDiv.innerHTML = `
                <strong>Q${index + 1}:</strong> ${question.text}<br>
                <strong>Your Answer:</strong> ${userAnswer || 'Not answered'}<br>
                <strong>Correct Answer:</strong> ${question.correct}<br>
                <span class="${isCorrect ? 'text-green-600' : 'text-red-600'}">${isCorrect ? 'âœ“ Correct' : 'âœ— Incorrect'}</span>
            `;
            detailedResults.appendChild(resultDiv);
        });
    }
    
    function restartExam() {
        if (questions.length > 0) {
            initializeExam();
        }
    }
    
    // ==========================
    // Init
    // ==========================
    window.onload = function () {
        renderTabs();
        loadActiveSet();
    };
</script>
</body>
</html>
