<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Exam Preparation</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .option-btn { transition: all 0.2s ease; }
    .option-btn:hover { background-color: #e5e7eb; }
    .correct { background-color: #10b981 !important; color: white; }
    .incorrect { background-color: #ef4444 !important; color: white; }
    .explanation { display: none; margin-top: 10px; padding: 10px; background-color: #f3f4f6; border-radius: 5px; }
    #progressBar { width: 0%; transition: width 0.35s ease; }
    #loading { display: block; }
    #examContent { display: none; }

    /* Tabs */
    .tab-btn { border-bottom: 2px solid transparent; }
    .tab-btn.active { color: #2563eb; border-color: #2563eb; font-weight: 600; }

    /* Animations */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes popIn {
      0% { transform: scale(0.9); opacity: 0; }
      60% { transform: scale(1.03); opacity: 1; }
      100% { transform: scale(1); }
    }
    @keyframes fadeOutDown {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(12px); }
    }
    .fade-in-up { animation: fadeInUp 0.4s ease both; }
    .pop-in { animation: popIn 0.45s ease both; }
    .fade-out-down { animation: fadeOutDown 0.3s ease both; }

    /* Simple confetti */
    .confetti {
      position: fixed;
      top: -10px;
      width: 8px;
      height: 14px;
      opacity: 0.9;
      transform: rotate(0deg);
      animation: confettiFall linear forwards;
      z-index: 50;
      border-radius: 2px;
    }
    @keyframes confettiFall {
      to { transform: translateY(110vh) rotate(720deg); opacity: 0.7; }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
  <div class="max-w-4xl mx-auto">
    <!-- Loading Screen -->
    <div id="loading" class="bg-white rounded-lg shadow-lg p-6 text-center">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">Loading Exam Questions...</h1>
      <p class="text-gray-600">Please wait while we load your questions.</p>
    </div>

    <!-- Main Exam Content -->
    <div id="examContent" class="fade-in-up">
      <!-- Header -->
      <div class="bg-white rounded-lg shadow-lg p-6 mb-4">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-4">Exam Preparation</h1>

        <!-- Tabs -->
        <div id="tabs" class="flex flex-wrap items-center gap-2 border-b pb-2 mb-4"></div>
        <p class="text-center text-sm text-gray-500">Loading from: <span id="fileNameLabel" class="font-mono"></span></p>

        <!-- Progress Bar -->
        <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
          <div id="progressBar" class="bg-blue-600 h-2 rounded-full"></div>
        </div>

        <!-- Score Display -->
        <div class="text-center">
          <span id="scoreDisplay" class="text-lg font-semibold">Score: 0/0</span>
          <span id="questionCounter" class="text-gray-600 ml-4">Question: 0/0</span>
        </div>
      </div>

      <!-- Question Display Area -->
      <div id="questionContainer" class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <div class="question-card">
          <h2 id="questionText" class="text-xl font-semibold mb-4"></h2>
          <div id="optionsContainer" class="space-y-3"></div>
          <div id="explanationContainer" class="explanation"></div>
          <div class="flex justify-between mt-6">
            <button id="prevBtn" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600" disabled>Previous</button>
            <button id="nextBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700" disabled>Next</button>
          </div>
        </div>
      </div>

      <!-- Results Section -->
      <div id="resultsContainer" class="bg-white rounded-lg shadow-lg p-6" style="display: none;">
        <h2 class="text-2xl font-bold text-center mb-4">Exam Results</h2>
        <div class="text-center text-3xl font-bold mb-1">
          <span id="scoreCount">0</span>/<span id="totalCount">0</span>
          <span class="text-xl text-gray-600 ml-2">(<span id="percentCount">0</span>%)</span>
        </div>
        <div id="finalScoreNote" class="text-center text-gray-600 mb-4"></div>
        <div id="detailedResults" class="space-y-2"></div>
        <div class="text-center mt-6">
          <button id="restartBtn" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">Reset Test</button>
        </div>
      </div>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mt-4" style="display: none;">
      <strong>Error:</strong> Could not load the selected questions file. Make sure the file exists in the same folder.
    </div>
  </div>

  <script>
    // 1) Configure your tabs here (label + txt file in the same folder)
    const QUIZ_TABS = [
      { label: 'History',   file: 'history.txt' },
      { label: 'Geography', file: 'geography.txt' },
      { label: 'Polity',    file: 'polity.txt' }
      // Add more: { label: 'Economy', file: 'economy.txt' }
    ];

    // Allow deep-link via ?file=filename.txt
    const urlFileParam = new URLSearchParams(location.search).get('file');

    // State
    let questions = [];
    let currentQuestionIndex = 0;
    let score = 0;
    let userAnswers = [];
    let answered = false;
    let currentFile = '';

    // DOM references
    const loadingEl = document.getElementById('loading');
    const examContentEl = document.getElementById('examContent');
    const errorMessageEl = document.getElementById('errorMessage');
    const fileNameLabel = document.getElementById('fileNameLabel');
    const tabsEl = document.getElementById('tabs');

    const questionContainer = document.getElementById('questionContainer');
    const questionText = document.getElementById('questionText');
    const optionsContainer = document.getElementById('optionsContainer');
    const explanationContainer = document.getElementById('explanationContainer');

    const scoreDisplay = document.getElementById('scoreDisplay');
    const questionCounter = document.getElementById('questionCounter');
    const progressBar = document.getElementById('progressBar');

    const resultsContainer = document.getElementById('resultsContainer');
    const detailedResults = document.getElementById('detailedResults');
    const scoreCount = document.getElementById('scoreCount');
    const totalCount = document.getElementById('totalCount');
    const percentCount = document.getElementById('percentCount');
    const finalScoreNote = document.getElementById('finalScoreNote');

    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const restartBtn = document.getElementById('restartBtn');

    // Build tabs UI
    function renderTabs(activeFile) {
      tabsEl.innerHTML = '';
      QUIZ_TABS.forEach(tab => {
        const btn = document.createElement('button');
        btn.className = 'tab-btn px-3 py-2 text-sm text-gray-700 hover:text-blue-600';
        btn.textContent = tab.label;
        btn.dataset.file = tab.file;
        if (tab.file === activeFile) btn.classList.add('active');
        btn.addEventListener('click', () => switchTab(tab.file));
        tabsEl.appendChild(btn);
      });
    }
    function setActiveTab(file) {
      [...document.querySelectorAll('.tab-btn')].forEach(b => {
        b.classList.toggle('active', b.dataset.file === file);
      });
    }

    // Load questions file
    async function loadQuestionsFromFile(fileName) {
      try {
        errorMessageEl.style.display = 'none';
        loadingEl.style.display = 'block';
        examContentEl.style.display = 'none';
        questionContainer.style.display = 'none';
        resultsContainer.style.display = 'none';

        const resp = await fetch(`${fileName}?v=${Date.now()}`, { cache: 'no-store' });
        if (!resp.ok) throw new Error(`Failed to fetch ${fileName} (HTTP ${resp.status})`);
        const content = await resp.text();

        const parsed = parseQuestions(content);
        if (!parsed.length) throw new Error('No valid questions parsed. Check the file format.');

        questions = parsed;
        currentFile = fileName;
        fileNameLabel.textContent = fileName;

        initializeExam();

        loadingEl.style.display = 'none';
        examContentEl.style.display = 'block';
        questionContainer.style.display = 'block';
        setActiveTab(fileName);
      } catch (err) {
        console.error(err);
        loadingEl.style.display = 'none';
        errorMessageEl.style.display = 'block';
      }
    }

    // Robust parser for your format:
    // 1. Question
    // a) option
    // b) option
    // c) option
    // d) option
    // Answer: b) 1921 (or Answer: b)
    // Explanation: text
    function parseQuestions(raw) {
      const text = raw.replace(/\r\n/g, '\n').trim();
      let blocks = text.split(/\n\s*\n+/);
      if (blocks.length === 1 && /^\d+\.\s/m.test(text)) {
        // fallback: split by number at line start
        blocks = text.split(/(?=^\d+\.\s+)/m);
      }

      const optionPattern = /^[A-Da-d]\s*[KATEX_INLINE_CLOSE\.\:\-]\s*(.+)$/;
      const parsed = [];

      blocks.forEach(block => {
        const lines = block.split('\n').map(l => l.trim()).filter(Boolean);
        if (!lines.length) return;

        // Question line (remove "1. " or "Q: ")
        let qLine = lines[0].replace(/^Q\s*[:\-]\s*/i, '').replace(/^\d+\.\s*/, '').trim();

        // Collect up to 4 options from subsequent lines
        const options = [];
        let cursor = 1;
        for (; cursor < lines.length && options.length < 4; cursor++) {
          const m = lines[cursor].match(optionPattern);
          if (m) options.push(m[1].trim());
        }
        if (options.length !== 4) return;

        // Find Answer line
        const answerLine = lines.slice(cursor).find(l => /^answer\s*[:\-]/i.test(l));
        if (!answerLine) return;

        // Parse answer letter or text
        let ans = answerLine.replace(/^answer\s*[:\-]\s*/i, '').trim();
        let letterMatch = ans.match(/^([A-Da-d])\b/);
        let correctLetter = null;
        let correctIndex = -1;
        if (letterMatch) {
          correctLetter = letterMatch[1].toUpperCase();
          correctIndex = correctLetter.charCodeAt(0) - 65;
        } else {
          // maybe they wrote the option text
          const cleaned = ans.replace(/^[A-Da-d]\s*[KATEX_INLINE_CLOSE\.\:\-]\s*/, '').trim().toLowerCase();
          correctIndex = options.findIndex(o => o.toLowerCase() === cleaned);
          if (correctIndex >= 0) correctLetter = String.fromCharCode(65 + correctIndex);
        }
        if (correctIndex < 0) return;

        // Explanation (optional)
        const explLine = lines.slice(cursor).find(l => /^explanation\s*[:\-]/i.test(l));
        const explanation = explLine ? explLine.replace(/^explanation\s*[:\-]\s*/i, '').trim() : 'No explanation provided.';

        parsed.push({
          text: qLine,
          options,
          correct: correctLetter,
          correctIndex,
          explanation
        });
      });

      return parsed;
    }

    // Initialize exam state
    function initializeExam() {
      currentQuestionIndex = 0;
      score = 0;
      userAnswers = new Array(questions.length).fill(null);
      answered = false;

      updateDisplay();
      displayQuestion();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Display current question
    function displayQuestion() {
      const q = questions[currentQuestionIndex];
      questionText.textContent = `${currentQuestionIndex + 1}. ${q.text}`;
      optionsContainer.innerHTML = '';

      q.options.forEach((option, idx) => {
        const letter = String.fromCharCode(65 + idx);
        const btn = document.createElement('button');
        btn.className = 'option-btn w-full text-left p-3 border rounded-lg hover:bg-gray-100';
        btn.textContent = `${letter}. ${option}`;
        btn.addEventListener('click', () => selectAnswer(letter));
        optionsContainer.appendChild(btn);
      });

      explanationContainer.style.display = 'none';
      answered = false;
      updateButtons();
    }

    // Handle answer selection
    function selectAnswer(selectedLetter) {
      if (answered) return;
      const q = questions[currentQuestionIndex];
      userAnswers[currentQuestionIndex] = selectedLetter;
      answered = true;

      const buttons = document.querySelectorAll('.option-btn');
      buttons.forEach((btn, idx) => {
        const letter = String.fromCharCode(65 + idx);
        if (letter === q.correct) {
          btn.classList.add('correct');
        } else if (letter === selectedLetter && selectedLetter !== q.correct) {
          btn.classList.add('incorrect');
        }
        btn.disabled = true;
      });

      if (selectedLetter === q.correct) score++;

      explanationContainer.innerHTML = `<strong>Explanation:</strong> ${q.explanation}`;
      explanationContainer.style.display = 'block';

      updateDisplay();
      updateButtons();
    }

    // Navigation
    function nextQuestion() {
      if (!answered) return; // require answer before moving on
      if (currentQuestionIndex < questions.length - 1) {
        currentQuestionIndex++;
        displayQuestion();
      } else {
        showResults();
      }
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    function previousQuestion() {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        displayQuestion();
      }
    }

    // Display updates
    function updateDisplay() {
      scoreDisplay.textContent = `Score: ${score}/${questions.length}`;
      questionCounter.textContent = `Question: ${currentQuestionIndex + 1}/${questions.length}`;
      const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
      progressBar.style.width = `${progress}%`;
      nextBtn.textContent = currentQuestionIndex === questions.length - 1 ? 'Show Results' : 'Next';
    }
    function updateButtons() {
      prevBtn.disabled = currentQuestionIndex === 0;
      nextBtn.disabled = !answered; // enable only after answering
    }

    // Results with animation
    function showResults() {
      questionContainer.classList.add('fade-out-down');
      setTimeout(() => {
        questionContainer.style.display = 'none';
        resultsContainer.style.display = 'block';
        resultsContainer.classList.add('pop-in');

        const pct = Math.round((score / questions.length) * 100);
        animateCount(scoreCount, 0, score, 700);
        totalCount.textContent = questions.length;
        animateCount(percentCount, 0, pct, 900);

        finalScoreNote.textContent = pct >= 60 ? 'Great job! 🎉' : 'Keep practicing! 💪';
        populateDetailedResults();

        if (pct >= 60) launchConfetti(80); // celebrate on 60%+
      }, 250);
    }

    function populateDetailedResults() {
      detailedResults.innerHTML = '';
      questions.forEach((q, i) => {
        const user = userAnswers[i];
        const ok = user === q.correct;
        const correctText = q.options[q.correctIndex];
        const userIndex = user ? user.charCodeAt(0) - 65 : -1;
        const userText = userIndex >= 0 ? q.options[userIndex] : 'Not answered';

        const div = document.createElement('div');
        div.className = `p-3 rounded ${ok ? 'bg-green-100' : 'bg-red-100'}`;
        div.innerHTML = `
          <strong>Q${i + 1}:</strong> ${q.text}<br>
          <strong>Your Answer:</strong> ${user || '-'} ${userIndex >= 0 ? '(' + userText + ')' : ''}<br>
          <strong>Correct Answer:</strong> ${q.correct} (${correctText})<br>
          <span class="${ok ? 'text-green-600' : 'text-red-600'}">${ok ? '✓ Correct' : '✗ Incorrect'}</span>
        `;
        detailedResults.appendChild(div);
      });
    }

    // Reset with animation
    function restartExam() {
      resultsContainer.classList.add('fade-out-down');
      setTimeout(() => {
        resultsContainer.style.display = 'none';
        resultsContainer.classList.remove('fade-out-down');
        questionContainer.style.display = 'block';
        questionContainer.classList.add('pop-in');
        initializeExam();
      }, 280);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Helpers
    function animateCount(el, from, to, duration = 800) {
      const start = performance.now();
      function tick(now) {
        const p = Math.min(1, (now - start) / duration);
        el.textContent = Math.floor(from + (to - from) * p);
        if (p < 1) requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    }

    function launchConfetti(n = 60) {
      for (let i = 0; i < n; i++) {
        const c = document.createElement('div');
        c.className = 'confetti';
        c.style.left = Math.random() * 100 + 'vw';
        c.style.background = randomColor();
        const dur = 1800 + Math.random() * 1500;
        c.style.animationDuration = dur + 'ms';
        c.style.transform = `translateY(-10px) rotate(${Math.random() * 360}deg)`;
        document.body.appendChild(c);
        setTimeout(() => c.remove(), dur + 100);
      }
    }
    function randomColor() {
      const colors = ['#ef4444','#f59e0b','#10b981','#3b82f6','#8b5cf6','#ec4899'];
      return colors[Math.floor(Math.random() * colors.length)];
    }

    // Tab switching
    function switchTab(file) {
      renderTabs(file);
      loadQuestionsFromFile(file);
    }

    // Events
    prevBtn.addEventListener('click', previousQuestion);
    nextBtn.addEventListener('click', nextQuestion);
    restartBtn.addEventListener('click', restartExam);

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', () => {
      // Determine the default tab/file (URL param takes priority)
      const fileFromParam = urlFileParam && QUIZ_TABS.find(t => t.file === urlFileParam)?.file;
      const defaultFile = fileFromParam || QUIZ_TABS[0].file;

      renderTabs(defaultFile);
      switchTab(defaultFile);
    });
  </script>
</body>
</html>
